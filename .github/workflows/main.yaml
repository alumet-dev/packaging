---
# This file is used to test the packaging workflows.
# This "Main pipeline" can be triggered manually.
name: Main pipeline
on:
  workflow_dispatch:
    inputs:
      version:
        description: Application version
        type: string
        required: false
        default: '0.0.0'
      revision:
        description: Package revision/release number
        required: false
        type: number
        default: 1
      tag:
        description: Tag to checkout in alumet repo
        type: string
        required: false
        default: 'main'

jobs:
  bin:
    strategy:
      fail-fast: false
      matrix: 
        arch: [x86_64, aarch64]
    uses: ./.github/workflows/build_musl_bin.yaml
    with:
      arch: ${{ matrix.arch }}
      version: ${{ github.event.inputs.version }}
      tag: ${{ github.event.inputs.tag }}
      revision: ${{ github.event.inputs.revision }}
  deb:
    strategy:
      fail-fast: false
      matrix: 
        arch: [x86_64, aarch64]
    uses: ./.github/workflows/build_musl_deb.yaml
    needs: 
      - bin
    with:
      arch: ${{ matrix.arch }}
      version: ${{ github.event.inputs.version }}
      tag: ${{ github.event.inputs.tag }}
      revision: ${{ github.event.inputs.revision }}
  rpm:
    strategy:
      fail-fast: false
      matrix: 
        arch: [x86_64, aarch64]
    uses: ./.github/workflows/build_musl_rpm.yaml
    needs: 
      - bin
    with:
      arch: ${{ matrix.arch }}
      version: ${{ github.event.inputs.version }}
      tag: ${{ github.event.inputs.tag }}
      revision: ${{ github.event.inputs.revision }}

  # rpm:
  #   uses: ./.github/workflows/build_rpm.yaml
  #   with:
  #     arch: x86_64
  #     version: ${{ github.event.inputs.version }}
  #     release-version: ${{ github.event.inputs.revision }}

  # deb:
  #   uses: ./.github/workflows/build_deb.yaml
  #   with:
  #     arch: amd64
  #     version: ${{ github.event.inputs.version }}
  #     revision: ${{ github.event.inputs.revision }}

  # docker:
  #   uses: ./.github/workflows/build_docker.yaml
  #   with:
  #     arch: x86_64
  #     version: ${{ github.event.inputs.version }}
  #     release-version: ${{ github.event.inputs.revision }}
  #   needs:
  #     - rpm
  #     - deb
